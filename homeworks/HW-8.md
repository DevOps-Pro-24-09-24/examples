**HW 8: Using Ansible Playbooks**
**App**: [GitHub - flask-alb-app](https://github.com/DevOps-Pro-24-09-24/examples/tree/main/flask-alb-app)
**Завдання**

Мета завдання полягає в тому, щоб налаштувати автоматизоване розгортання AMI образів для додатку та бази даних за допомогою **Ansible** в якості провіженера для **Packer**, а також автоматизації деплоя аплікації.

**Кроки**
1. **Переробка Packer-шаблонів для використання Ansible:**
• Створіть два плейбуки:
• app_install.yml – для встановлення необхідних системних пакетів для додатку.
• db_install.yml – для встановлення системних пакетів бази даних, створення бази даних та користувача.

2. **Написання плейбука для деплоя аплікації:**
• deploy.yml – для отримання коду з репозиторію, встановлення залежностей за допомогою pip, створення сервісу для додатку і його запуску.
3. **Оновлення Packer-шаблонів:**
• Видаліть секцію provisioners з шаблонів Packer і додайте нову секцію для використання Ansible як провіженера.
• Приклад конфігурації для провіженера **Ansible** у Packer:

  
```json
"provisioners": [
  {
    "type": "ansible",
    "playbook_file": "../ansible/db_install.yml",
    "extra_arguments": [
      "--extra-vars", "mysql_user={{user `db_user`}} mysql_pass={{user `db_pass`}} mysql_db={{user `db_name`}}"
    ]
  }
]
```

• Передавайте додаткові параметри через extra_arguments для визначення користувача, пароля та назви бази даних.

4. **Конфігурація** db_install.yml**:**

• Для роботи з MySQL використовуйте модулі mysql_user та mysql_db з колекції [community.mysql](https://docs.ansible.com/ansible/latest/collections/community/mysql/index.html).

• Встановіть необхідні пакети Python, наприклад pymysql, для підтримки модулів MySQL:

```yaml
- name: Install PyMySQL
  apt:
    name: python3-pymysql
    state: present
```

• Налаштуйте MySQL для прослуховування всіх IP-адрес, а не тільки локальних (127.0.0.1). Це можна зробити за допомогою модуля blockinfile, copy або template для зміни конфігураційного файлу /etc/mysql/my.cnf:

```yaml
- blockinfile:
    path: /etc/mysql/my.cnf
    block: |
      [mysqld]
      bind-address = 0.0.0.0
```
  

5. **Конфігурація** app_install.yml**:**

• Встановіть всі необхідні системні пакети для запуску додатку (наприклад, Python та необхідні бібліотеки).

• Приклад встановлення:

```yaml
- name: Install required packages
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - python3
    - python3-pip
```
  

6. **Згенерований AMI образ:**
• Використовуйте Packer для створення AMI образів з встановленим додатком та базою даних.
• Для кожного з цих образів використовуйте відповідні плейбуки (app_install.yml та db_install.yml).
7. **Деплой аппки:**
• Використовуйте плейбук deploy.yml, щоб отримати код додатку, встановити залежності через pip, створити systemd сервіс для додатку, та запустити його.
• Встановіть з’єднання між додатком та базою даних через внутрішню IP-адресу інстансу бази даних.
8. **Security Groups:**
• Переконайтеся, що у Security Group налаштовані необхідні правила для доступу до порту 8000 для аплікації, а також для доступу додатку до бази даних.
**Структура директорій Ansible:**
```bash
ansible/
├── ansible.cfg        # Конфігураційний файл Ansible
├── inventory          # Inventory файл для серверів
├── app_install.yml    # Плейбук для встановлення системних пакетів додатку
├── db_install.yml     # Плейбук для встановлення системних пакетів бази даних
└── deploy.yml         # Плейбук для деплоя додатку
```

**Критерії успішності:**

1. **Створені AMI образи:**
• Створено два AMI образи за допомогою Packer:
• app образ з встановленим додатком.
• db образ з встановленою базою даних.

2. **Розгорнуті ресурси:**
• EC2 інстанси на базі створених AMI:
• Інстанс app – розгорнутий з AMI для додатку.
• Інстанс db – розгорнутий з AMI для бази даних.

3. **Деплой додатку:**
• Плейбук deploy.yml повинен успішно виконати встановлення останньої версії додатку на інстансі app.

4. **Перевірка доступності додатку:**
• Додаток повинен бути доступний на порту **8000** за URL:
        http://<app_instance_dns_or_ip>:8000.

